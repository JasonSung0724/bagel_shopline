name: Build and Deploy to GCP VM

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_ID: mybagel-458109
  GCE_INSTANCE: instance-20250531-132235
  GCE_ZONE: us-central1-c
  REGISTRY: us-central1-docker.pkg.dev
  REPOSITORY: bagel-repo

jobs:
  # ===========================================
  # Detect Changes
  # ===========================================
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      worker: ${{ steps.filter.outputs.worker }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'src/**'
              - 'Dockerfile'
              - 'requirements.txt'
              - 'app.py'
            worker:
              - 'src/**'
              - 'Dockerfile.worker'
              - 'requirements.txt'
              - 'crontab'
              - 'main_scripts.py'
              - 'sub_scripts.py'
              - 'sales_scripts.py'
              - 'inventory_scripts.py'
            frontend:
              - 'frontend/**'

  # ===========================================
  # Build API Image
  # ===========================================
  build-api:
    name: Build API Image
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.backend == 'true' || github.event_name == 'workflow_dispatch'

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGISTRY }} --quiet

      - name: Build and Push API Image
        run: |
          docker build -f Dockerfile -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/api:${{ github.sha }} .
          docker tag ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/api:${{ github.sha }} ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/api:latest
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/api:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/api:latest

  # ===========================================
  # Build Worker Image
  # ===========================================
  build-worker:
    name: Build Worker Image
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.worker == 'true' || github.event_name == 'workflow_dispatch'

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGISTRY }} --quiet

      - name: Build and Push Worker Image
        run: |
          docker build -f Dockerfile.worker -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/worker:${{ github.sha }} .
          docker tag ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/worker:${{ github.sha }} ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/worker:latest
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/worker:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/worker:latest

  # ===========================================
  # Build Frontend Image
  # ===========================================
  build-frontend:
    name: Build Frontend Image
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.frontend == 'true' || github.event_name == 'workflow_dispatch'

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGISTRY }} --quiet

      - name: Build and Push Frontend Image
        run: |
          docker build -f frontend/Dockerfile -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/frontend:${{ github.sha }} ./frontend
          docker tag ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/frontend:${{ github.sha }} ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/frontend:latest
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/frontend:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/frontend:latest

  # ===========================================
  # Deploy to GCP VM
  # ===========================================
  deploy:
    name: Deploy to GCP VM
    runs-on: ubuntu-latest
    needs: [changes, build-api, build-worker, build-frontend]
    if: always() && !cancelled() && !failure()

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Create .env file on VM
        run: |
          gcloud compute ssh ${{ env.GCE_INSTANCE }} --zone=${{ env.GCE_ZONE }} --command="
            sudo mkdir -p /opt/bagel-shop
            sudo chown \$(whoami):\$(whoami) /opt/bagel-shop
            cat > /opt/bagel-shop/.env << 'EOF'
          REGISTRY=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}
          TAG=latest
          SHOPLINE_TOKEN=${{ secrets.SHOPLINE_TOKEN }}
          GMAIL_ADDRESS=${{ secrets.GMAIL_ADDRESS }}
          GMAIL_APP_PASSWORD=${{ secrets.GMAIL_APP_PASSWORD }}
          LINE_ACCESS_TOKEN=${{ secrets.LINE_ACCESS_TOKEN }}
          LINE_GROUP_ID=${{ secrets.LINE_GROUP_ID }}
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY=${{ secrets.SUPABASE_KEY }}
          INVENTORY_PASSWORD=${{ secrets.INVENTORY_PASSWORD }}
          LOTTERY_ADMIN_PASSWORD=${{ secrets.LOTTERY_ADMIN_PASSWORD }}
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          EOF
          "

      - name: Create Google Service Account file on VM
        run: |
          # GCP_SA_KEY should be base64 encoded
          # To encode: cat service-account.json | base64
          gcloud compute ssh ${{ env.GCE_INSTANCE }} --zone=${{ env.GCE_ZONE }} --command="
            mkdir -p /opt/bagel-shop/secrets
            echo '${{ secrets.GCP_SA_KEY }}' | base64 -d > /opt/bagel-shop/secrets/google-sa.json
            chmod 600 /opt/bagel-shop/secrets/google-sa.json
          "

      - name: Copy migration files to VM
        run: |
          gcloud compute ssh ${{ env.GCE_INSTANCE }} --zone=${{ env.GCE_ZONE }} --command="mkdir -p /opt/bagel-shop/supabase/migrations"
          gcloud compute scp --recurse supabase/migrations/* ${{ env.GCE_INSTANCE }}:/opt/bagel-shop/supabase/migrations/ --zone=${{ env.GCE_ZONE }}

      - name: Run database migrations on VM
        run: |
          gcloud compute ssh ${{ env.GCE_INSTANCE }} --zone=${{ env.GCE_ZONE }} --command="
            cd /opt/bagel-shop

            # Install psql if not already installed
            if ! command -v psql &> /dev/null; then
              echo 'Installing PostgreSQL client...'
              sudo apt-get update && sudo apt-get install -y postgresql-client
            fi

            # Source environment variables
            set -a
            source .env
            set +a

            # Run all migration files in order
            for migration in supabase/migrations/*.sql; do
              if [ -f \"\$migration\" ]; then
                echo \"Running migration: \$migration\"
                psql \"\$DATABASE_URL\" -f \"\$migration\"
              fi
            done

            echo 'Migrations completed successfully'
          "

      - name: Deploy to VM
        env:
          PULL_API: ${{ needs.changes.outputs.backend == 'true' || github.event_name == 'workflow_dispatch' }}
          PULL_WORKER: ${{ needs.changes.outputs.worker == 'true' || github.event_name == 'workflow_dispatch' }}
          PULL_FRONTEND: ${{ needs.changes.outputs.frontend == 'true' || github.event_name == 'workflow_dispatch' }}
        run: |
          # Copy docker-compose.yml and nginx config to VM
          gcloud compute scp docker-compose.yml ${{ env.GCE_INSTANCE }}:/opt/bagel-shop/docker-compose.yml --zone=${{ env.GCE_ZONE }}
          gcloud compute ssh ${{ env.GCE_INSTANCE }} --zone=${{ env.GCE_ZONE }} --command="mkdir -p /opt/bagel-shop/nginx"
          gcloud compute scp nginx/nginx.conf ${{ env.GCE_INSTANCE }}:/opt/bagel-shop/nginx/nginx.conf --zone=${{ env.GCE_ZONE }}

          # Build list of images to pull based on changes
          IMAGES_TO_PULL=""
          if [ "$PULL_API" = "true" ]; then
            IMAGES_TO_PULL="$IMAGES_TO_PULL api"
            echo "ðŸ“¦ Will pull: api"
          fi
          if [ "$PULL_WORKER" = "true" ]; then
            IMAGES_TO_PULL="$IMAGES_TO_PULL worker"
            echo "ðŸ“¦ Will pull: worker"
          fi
          if [ "$PULL_FRONTEND" = "true" ]; then
            IMAGES_TO_PULL="$IMAGES_TO_PULL frontend"
            echo "ðŸ“¦ Will pull: frontend"
          fi

          # Run deployment commands on VM
          gcloud compute ssh ${{ env.GCE_INSTANCE }} --zone=${{ env.GCE_ZONE }} --command="
            cd /opt/bagel-shop

            # Authenticate to Artifact Registry
            gcloud auth configure-docker ${{ env.REGISTRY }} --quiet

            # Create logs directory
            mkdir -p logs

            # Pull only changed images (selective pull)
            IMAGES='$IMAGES_TO_PULL'
            if [ -n \"\$IMAGES\" ]; then
              echo 'ðŸš€ Pulling changed images:' \$IMAGES
              docker compose pull \$IMAGES
            else
              echo 'â­ï¸ No image changes, skipping pull'
            fi

            # Restart containers with new images (including nginx)
            docker compose up -d --force-recreate api worker frontend nginx

            # Clean up old images
            docker image prune -f

            # Show container status
            docker compose ps
          "

      - name: Health Check
        run: |
          sleep 30
          gcloud compute ssh ${{ env.GCE_INSTANCE }} --zone=${{ env.GCE_ZONE }} \
            --command="curl -f http://localhost:3000/health || exit 1"

      - name: Cleanup Old Images in Artifact Registry
        if: success()
        run: |
          for IMAGE in api worker frontend; do
            echo "Cleaning up old $IMAGE images..."
            gcloud artifacts docker images list \
              ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/$IMAGE \
              --sort-by=~CREATE_TIME \
              --format="get(version)" \
              --filter="tags!~latest" \
              | tail -n +6 \
              | xargs -I {} gcloud artifacts docker images delete \
                  ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/$IMAGE@{} \
                  --quiet --delete-tags 2>/dev/null || true
          done

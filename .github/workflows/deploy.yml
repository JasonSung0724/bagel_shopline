name: Build and Deploy to GCP VM

on:
  push:
    branches:
      - revamp
  workflow_dispatch: # Allow manual trigger

env:
  PROJECT_ID: mybagel-458109
  GCE_INSTANCE: instance-20250531-132235
  GCE_ZONE: us-central1-c
  REGISTRY: us-central1-docker.pkg.dev
  REPOSITORY: bagel-repo

jobs:
  # ===========================================
  # Detect Changes
  # ===========================================
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      worker: ${{ steps.filter.outputs.worker }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'src/**'
              - 'Dockerfile'
              - 'requirements.txt'
              - 'main_scripts.py'
              - 'sub_scripts.py'
            worker:
              - 'src/**'
              - 'Dockerfile.worker'
              - 'requirements.txt'
              - 'crontab'
              - 'main_scripts.py'
              - 'sub_scripts.py'
            frontend:
              - 'frontend/**'

  # ===========================================
  # Build and Push Docker Images (only if changed)
  # ===========================================
  build-api:
    name: Build API Image
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.backend == 'true' || github.event_name == 'workflow_dispatch'

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGISTRY }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push API Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/api:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/api:latest
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/api:cache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/api:cache,mode=max

  build-worker:
    name: Build Worker Image
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.worker == 'true' || github.event_name == 'workflow_dispatch'

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGISTRY }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Worker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.worker
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/worker:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/worker:latest
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/worker:cache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/worker:cache,mode=max

  build-frontend:
    name: Build Frontend Image
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.frontend == 'true' || github.event_name == 'workflow_dispatch'

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGISTRY }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Frontend Image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/frontend:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/frontend:latest
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/frontend:cache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/frontend:cache,mode=max

  # ===========================================
  # Deploy to GCP VM
  # ===========================================
  deploy:
    name: Deploy to GCP VM
    runs-on: ubuntu-latest
    needs: [changes, build-api, build-worker, build-frontend]
    # Run deploy if any build ran, or if no changes (just redeploy)
    if: always() && !cancelled() && !failure()

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to VM via SSH
        run: |
          gcloud compute ssh ${{ env.GCE_INSTANCE }} \
            --zone=${{ env.GCE_ZONE }} \
            --command="
              set -e

              echo '=== Authenticating to Artifact Registry ==='
              gcloud auth configure-docker ${{ env.REGISTRY }} --quiet

              echo '=== Pulling latest images ==='
              docker pull ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/api:latest || true
              docker pull ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/worker:latest || true
              docker pull ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/frontend:latest || true

              echo '=== Navigating to project directory ==='
              cd /opt/bagel-shop

              echo '=== Updating docker-compose.yml ==='
              git pull origin revamp || true

              echo '=== Restarting containers ==='
              docker compose down
              docker compose up -d

              echo '=== Cleaning up old images ==='
              docker image prune -f
              docker image prune -a -f --filter 'until=24h'

              echo '=== Deployment complete ==='
              docker compose ps
            "

      - name: Cleanup Old Images in Artifact Registry
        run: |
          # Keep only the latest 5 images for each repository
          for IMAGE in api worker frontend; do
            echo "Cleaning up old $IMAGE images..."
            gcloud artifacts docker images list \
              ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/$IMAGE \
              --sort-by=~CREATE_TIME \
              --format="get(version)" \
              --filter="tags!~latest AND tags!~cache" \
              | tail -n +6 \
              | xargs -I {} gcloud artifacts docker images delete \
                  ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/$IMAGE@{} \
                  --quiet --delete-tags 2>/dev/null || true
          done

      - name: Health Check
        run: |
          sleep 30
          gcloud compute ssh ${{ env.GCE_INSTANCE }} \
            --zone=${{ env.GCE_ZONE }} \
            --command="curl -f http://localhost:8080/health || exit 1"

name: Build and Deploy to GCP VM

on:
  push:
    branches:
      - revamp
  workflow_dispatch: # Allow manual trigger

env:
  PROJECT_ID: mybagel-458109
  GCE_INSTANCE: instance-20250531-132235
  GCE_ZONE: us-central1-c
  REGISTRY: us-central1-docker.pkg.dev
  REPOSITORY: bagel-repo

jobs:
  # ===========================================
  # Detect Changes
  # ===========================================
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      worker: ${{ steps.filter.outputs.worker }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'src/**'
              - 'Dockerfile'
              - 'requirements.txt'
              - 'main_scripts.py'
              - 'sub_scripts.py'
            worker:
              - 'src/**'
              - 'Dockerfile.worker'
              - 'requirements.txt'
              - 'crontab'
              - 'main_scripts.py'
              - 'sub_scripts.py'
            frontend:
              - 'frontend/**'

  # ===========================================
  # Build and Push Docker Images (only if changed)
  # ===========================================
  build-api:
    name: Build API Image
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.backend == 'true' || github.event_name == 'workflow_dispatch'

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGISTRY }}

      - name: Build and Push API Image
        run: |
          docker build -f Dockerfile -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/api:${{ github.sha }} .
          docker tag ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/api:${{ github.sha }} ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/api:latest
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/api:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/api:latest

  build-worker:
    name: Build Worker Image
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.worker == 'true' || github.event_name == 'workflow_dispatch'

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug - List src/config contents
        run: |
          echo "=== Checking src/config directory ==="
          ls -la src/config/ || echo "src/config does not exist"
          echo "=== Git status ==="
          git status
          git log --oneline -3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGISTRY }}

      - name: Build and Push Worker Image
        run: |
          docker build -f Dockerfile.worker -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/worker:${{ github.sha }} .
          docker tag ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/worker:${{ github.sha }} ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/worker:latest
          echo "=== Verify image contents ==="
          docker run --rm ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/worker:${{ github.sha }} ls -la /app/src/config/
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/worker:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/worker:latest

  build-frontend:
    name: Build Frontend Image
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.frontend == 'true' || github.event_name == 'workflow_dispatch'

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGISTRY }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Frontend Image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/frontend:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/frontend:latest
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/frontend:cache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/frontend:cache,mode=max

  # ===========================================
  # Deploy to GCP VM
  # ===========================================
  deploy:
    name: Deploy to GCP VM
    runs-on: ubuntu-latest
    needs: [changes, build-api, build-worker, build-frontend]
    # Run deploy if any build ran, or if no changes (just redeploy)
    if: always() && !cancelled() && !failure()

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Create deployment script
        run: |
          cat > deploy_script.sh << 'SCRIPT_EOF'
          #!/bin/bash
          set -e

          echo '=== Setting up project directory ==='
          sudo mkdir -p /opt/bagel-shop
          sudo chown $(whoami):$(whoami) /opt/bagel-shop
          cd /opt/bagel-shop

          echo '=== Authenticating to Artifact Registry ==='
          gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

          echo '=== Pulling latest images ==='
          docker pull us-central1-docker.pkg.dev/mybagel-458109/bagel-repo/api:latest || true
          docker pull us-central1-docker.pkg.dev/mybagel-458109/bagel-repo/worker:latest || true
          docker pull us-central1-docker.pkg.dev/mybagel-458109/bagel-repo/frontend:latest || true

          echo '=== docker-compose.yml will be copied via scp ==='

          echo '=== Creating required directories ==='
          mkdir -p logs

          echo '=== Stopping old containers ==='
          docker compose down || true

          echo '=== Starting containers ==='
          docker compose up -d api worker frontend

          echo '=== Cleaning up old images ==='
          docker image prune -f
          docker image prune -a -f --filter 'until=24h' || true

          echo '=== Deployment complete ==='
          docker compose ps
          SCRIPT_EOF
          chmod +x deploy_script.sh

      - name: Create .env file on VM
        run: |
          gcloud compute ssh ${{ env.GCE_INSTANCE }} --zone=${{ env.GCE_ZONE }} --command="
            sudo mkdir -p /opt/bagel-shop
            sudo chown \$(whoami):\$(whoami) /opt/bagel-shop
            cat > /opt/bagel-shop/.env << 'ENVEOF'
          REGISTRY=us-central1-docker.pkg.dev/mybagel-458109/bagel-repo
          TAG=latest
          SHOPLINE_TOKEN=${{ secrets.SHOPLINE_TOKEN }}
          GMAIL_ADDRESS=${{ secrets.GMAIL_ADDRESS }}
          GMAIL_APP_PASSWORD=${{ secrets.GMAIL_APP_PASSWORD }}
          LINE_ACCESS_TOKEN=${{ secrets.LINE_ACCESS_TOKEN }}
          LINE_GROUP_ID=${{ secrets.LINE_GROUP_ID }}
          ENVEOF
          "

      - name: Copy files and run deployment script
        run: |
          gcloud compute scp deploy_script.sh ${{ env.GCE_INSTANCE }}:/tmp/deploy_script.sh --zone=${{ env.GCE_ZONE }}
          gcloud compute scp docker-compose.yml ${{ env.GCE_INSTANCE }}:/opt/bagel-shop/docker-compose.yml --zone=${{ env.GCE_ZONE }}
          gcloud compute ssh ${{ env.GCE_INSTANCE }} --zone=${{ env.GCE_ZONE }} --command="bash /tmp/deploy_script.sh"

      - name: Cleanup Old Images in Artifact Registry
        run: |
          # Keep only the latest 5 images for each repository
          for IMAGE in api worker frontend; do
            echo "Cleaning up old $IMAGE images..."
            gcloud artifacts docker images list \
              ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/$IMAGE \
              --sort-by=~CREATE_TIME \
              --format="get(version)" \
              --filter="tags!~latest AND tags!~cache" \
              | tail -n +6 \
              | xargs -I {} gcloud artifacts docker images delete \
                  ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/$IMAGE@{} \
                  --quiet --delete-tags 2>/dev/null || true
          done

      - name: Health Check
        run: |
          sleep 30
          gcloud compute ssh ${{ env.GCE_INSTANCE }} \
            --zone=${{ env.GCE_ZONE }} \
            --command="curl -f http://localhost:8080/health || exit 1"

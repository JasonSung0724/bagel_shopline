<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Ma+Shan+Zheng&display=swap');

* {
  box-sizing: border-box;
}

.lottery-wrapper {
  font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, sans-serif;
  max-width: 480px;
  margin: 0 auto;
  padding: 20px;
  padding-bottom: 120px;
  perspective: 1000px;
  position: relative;
  z-index: 10;
}


.lottery-bg {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #8B0000 0%, #DC143C 30%, #B22222 60%, #8B0000 100%);
  background-size: 400% 400%;
  animation: gradientBG 15s ease infinite;
  z-index: -2;
}

.lottery-bg::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background:
    radial-gradient(circle at 20% 20%, rgba(255, 215, 0, 0.15) 0%, transparent 40%),
    radial-gradient(circle at 80% 80%, rgba(255, 215, 0, 0.15) 0%, transparent 40%),
    radial-gradient(circle at 50% 50%, rgba(255, 215, 0, 0.1) 0%, transparent 60%);
  pointer-events: none;
}

@keyframes gradientBG {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}


.particles {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  overflow: hidden;
  z-index: -1;
}

.particle {
  position: absolute;
  animation: float 35s infinite;
}

.particle.coin {
  width: 30px;
  height: 30px;
  background: radial-gradient(circle at 30% 30%, #FFD700, #DAA520);
  border-radius: 50%;
  box-shadow: inset -3px -3px 8px rgba(0,0,0,0.3), 0 0 10px rgba(255, 215, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  color: #8B0000;
  font-weight: bold;
}

.particle.lantern {
  width: 20px;
  height: 28px;
  background: linear-gradient(180deg, #FF4500 0%, #DC143C 50%, #8B0000 100%);
  border-radius: 50% 50% 45% 45%;
  box-shadow: 0 0 15px rgba(255, 69, 0, 0.6);
  position: relative;
}

.particle.lantern::before {
  content: '';
  position: absolute;
  top: -5px;
  left: 50%;
  transform: translateX(-50%);
  width: 10px;
  height: 5px;
  background: #FFD700;
  border-radius: 2px;
}

.particle.lantern::after {
  content: '';
  position: absolute;
  bottom: -8px;
  left: 50%;
  transform: translateX(-50%);
  width: 2px;
  height: 8px;
  background: #FFD700;
}

@keyframes float {
  0%, 100% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
  10% { opacity: 1; }
  90% { opacity: 1; }
  100% { transform: translateY(-100vh) rotate(720deg); opacity: 0; }
}


.horse-container {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 120px;
  pointer-events: none;
  overflow: hidden;
  z-index: 5;
}

.running-horse {
  position: absolute;
  bottom: 10px;
  animation: horseRun 25s linear infinite;
  filter: drop-shadow(0 5px 15px rgba(0,0,0,0.3));
}

@keyframes horseRun {
  0% { left: -200px; transform: scaleX(1); }
  49.9% { left: calc(100% + 200px); transform: scaleX(1); }
  50% { left: calc(100% + 200px); transform: scaleX(-1); }
  99.9% { left: -200px; transform: scaleX(-1); }
  100% { left: -200px; transform: scaleX(1); }
}

.running-horse.horse-2 {
  animation-delay: -5s;
  bottom: 50px;
  opacity: 0.6;
}

.running-horse.horse-2 svg {
  width: 100px;
  height: 70px;
}


.firecracker-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 1;
}

.firecracker-string {
  position: absolute;
  top: -10px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.firecracker-string.left {
  left: 10px;
  animation: swingLeft 2s ease-in-out infinite;
  transform-origin: top center;
}

.firecracker-string.right {
  right: 10px;
  animation: swingRight 2s ease-in-out infinite;
  transform-origin: top center;
}

@keyframes swingLeft {
  0%, 100% { transform: rotate(-3deg); }
  50% { transform: rotate(3deg); }
}

@keyframes swingRight {
  0%, 100% { transform: rotate(3deg); }
  50% { transform: rotate(-3deg); }
}

.firecracker-rope {
  width: 3px;
  height: 12px;
  background: linear-gradient(180deg, #8B4513, #A0522D);
}

.firecracker {
  width: 18px;
  height: 28px;
  background: linear-gradient(90deg, #DC143C 0%, #FF6347 30%, #FF4500 50%, #FF6347 70%, #DC143C 100%);
  border-radius: 4px;
  position: relative;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3), inset 0 1px 2px rgba(255,255,255,0.3);
  margin: 1px 0;
}

.firecracker::before {
  content: '';
  position: absolute;
  top: -6px;
  left: 50%;
  transform: translateX(-50%);
  width: 2px;
  height: 8px;
  background: linear-gradient(180deg, #FFD700, #8B4513);
}

.firecracker::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 10px;
  height: 2px;
  background: #FFD700;
  box-shadow: 0 4px 0 #FFD700, 0 -4px 0 #FFD700;
}


.firecracker-spark {
  position: absolute;
  width: 4px;
  height: 4px;
  background: #FFD700;
  border-radius: 50%;
  animation: sparkle 0.5s ease-out infinite;
  box-shadow: 0 0 6px #FFD700, 0 0 10px #FF4500;
}

@keyframes sparkle {
  0% { opacity: 1; transform: scale(1); }
  100% { opacity: 0; transform: scale(0); }
}


.lottery-card {
  background: linear-gradient(135deg, #FFF8DC 0%, #FFFAF0 50%, #FFF8DC 100%);
  border-radius: 24px;
  box-shadow:
    0 25px 80px rgba(139, 0, 0, 0.4),
    0 0 0 4px #FFD700,
    0 0 0 8px #DC143C,
    inset 0 0 30px rgba(255, 215, 0, 0.1);
  overflow: hidden;
  transform-style: preserve-3d;
  transition: transform 0.6s ease;
  position: relative;
}

.lottery-card::before {
  content: 'Á¶è';
  position: absolute;
  top: 10px;
  right: 10px;
  font-size: 40px;
  color: rgba(220, 20, 60, 0.1);
  font-family: 'Ma Shan Zheng', cursive;
  z-index: 0;
}

.lottery-card:hover {
  transform: translateY(-5px);
}


.lottery-header {
  background: linear-gradient(135deg, #DC143C 0%, #B22222 50%, #8B0000 100%);
  padding: 30px 20px;
  text-align: center;
  position: relative;
  overflow: hidden;
}

.lottery-header::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(255, 215, 0, 0.3) 0%, transparent 60%);
  animation: shimmer 3s ease-in-out infinite;
}

.lottery-header::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 8px;
  background: linear-gradient(90deg,
    transparent 0%,
    #FFD700 10%,
    #FFD700 20%,
    transparent 30%,
    transparent 40%,
    #FFD700 50%,
    #FFD700 60%,
    transparent 70%,
    transparent 80%,
    #FFD700 90%,
    transparent 100%
  );
  background-size: 200% 100%;
  animation: borderShine 3s linear infinite;
}

@keyframes borderShine {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

@keyframes shimmer {
  0%, 100% { transform: translate(-30%, -30%); }
  50% { transform: translate(30%, 30%); }
}

.lottery-icon {
  width: 80px;
  height: 80px;
  margin: 0 auto 15px;
  animation: bounce 2s ease infinite;
  filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3));
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

.lottery-title {
  font-size: 32px;
  font-weight: 900;
  color: #FFD700;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.5), 0 0 20px rgba(255, 215, 0, 0.5);
  margin: 0 0 10px;
  position: relative;
  z-index: 1;
  font-family: 'Noto Sans TC', sans-serif;
}

.lottery-subtitle {
  font-size: 16px;
  color: rgba(255, 248, 220, 0.95);
  margin: 0;
  position: relative;
  z-index: 1;
}


.cny-blessing {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-top: 15px;
  position: relative;
  z-index: 1;
}

.blessing-char {
  width: 36px;
  height: 36px;
  background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  font-weight: bold;
  color: #8B0000;
  box-shadow: 0 3px 10px rgba(0,0,0,0.3);
  transform: rotate(-5deg);
  animation: blessingPop 0.5s ease backwards;
}

.blessing-char:nth-child(2) { animation-delay: 0.1s; transform: rotate(3deg); }
.blessing-char:nth-child(3) { animation-delay: 0.2s; transform: rotate(-2deg); }
.blessing-char:nth-child(4) { animation-delay: 0.3s; transform: rotate(4deg); }

@keyframes blessingPop {
  0% { transform: scale(0) rotate(0deg); }
  100% { transform: scale(1) rotate(var(--rotate, -5deg)); }
}


.lottery-content {
  padding: 30px 25px;
  background: linear-gradient(180deg, rgba(255, 248, 220, 0) 0%, rgba(255, 215, 0, 0.05) 100%);
}


.lottery-attempts-box {
  background: linear-gradient(135deg, #FFF5F5 0%, #FFE4E1 100%);
  border: 3px solid #DC143C;
  border-radius: 16px;
  padding: 15px 20px;
  margin-bottom: 25px;
  text-align: center;
  animation: pulse 2s ease infinite;
  position: relative;
  overflow: hidden;
}

.lottery-attempts-box::before {
  content: 'üßß';
  position: absolute;
  top: 5px;
  left: 10px;
  font-size: 24px;
  opacity: 0.3;
}

.lottery-attempts-box::after {
  content: 'üßß';
  position: absolute;
  bottom: 5px;
  right: 10px;
  font-size: 24px;
  opacity: 0.3;
}

@keyframes pulse {
  0%, 100% { box-shadow: 0 0 0 0 rgba(220, 20, 60, 0.4); }
  50% { box-shadow: 0 0 0 10px rgba(220, 20, 60, 0); }
}

.lottery-attempts-text {
  font-size: 16px;
  color: #8B0000;
  margin: 0;
}

.lottery-attempts-count {
  font-size: 36px;
  font-weight: 900;
  color: #DC143C;
  display: block;
  margin-top: 5px;
  text-shadow: 0 2px 4px rgba(220, 20, 60, 0.3);
}


.lottery-notice-section {
  margin-bottom: 20px;
  padding: 12px 16px;
  background: linear-gradient(135deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 215, 0, 0.05) 100%);
  border: 1px solid rgba(255, 215, 0, 0.3);
  border-radius: 12px;
  position: relative;
}

.lottery-notice-section::before {
  content: 'üì¢';
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 16px;
}

.lottery-notice-text {
  margin: 0;
  padding-left: 28px;
  font-size: 13px;
  color: #8B0000;
  line-height: 1.6;
  white-space: pre-wrap;
}


.lottery-prizes-section {
  margin-bottom: 25px;
}

.lottery-prizes-title {
  font-size: 14px;
  color: #8B0000;
  text-align: center;
  margin-bottom: 15px;
  letter-spacing: 2px;
}

.lottery-prizes-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  gap: 12px;
  justify-content: center;
  margin-bottom: 25px;
}


.lottery-prize-card {
  background: linear-gradient(135deg, #FFF8DC 0%, #FFFAF0 100%);
  border: 2px solid #FFD700;
  border-radius: 12px;
  padding: 10px;
  text-align: center;
  transition: all 0.3s ease;
  box-shadow: 0 3px 10px rgba(218, 165, 32, 0.2);
}

.lottery-prize-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 5px 20px rgba(218, 165, 32, 0.4);
}

.lottery-prize-card img {
  width: 70px;
  height: 70px;
  object-fit: cover;
  border-radius: 8px;
  margin-bottom: 8px;
  border: 1px solid #DAA520;
}

.lottery-prize-card .prize-placeholder {
  width: 70px;
  height: 70px;
  background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
  border-radius: 8px;
  margin: 0 auto 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
}

.lottery-prize-card span {
  display: block;
  font-size: 12px;
  font-weight: 600;
  color: #8B0000;
  line-height: 1.3;
  word-break: break-word;
}


.lottery-prize-chip {
  background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
  border: 2px solid #DAA520;
  border-radius: 50px;
  padding: 8px 16px;
  font-size: 14px;
  color: #8B0000;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: 0 3px 10px rgba(218, 165, 32, 0.3);
}

.lottery-prize-chip:hover {
  transform: scale(1.1) rotate(-2deg);
  box-shadow: 0 5px 20px rgba(218, 165, 32, 0.5);
}


.lottery-start-btn {
  width: 100%;
  padding: 20px 40px;
  font-size: 22px;
  font-weight: 700;
  color: #8B0000;
  background: linear-gradient(135deg, #FFD700 0%, #FFA500 50%, #FFD700 100%);
  background-size: 200% 200%;
  border: 3px solid #DAA520;
  border-radius: 16px;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
  animation: gradientBtn 3s ease infinite;
  box-shadow: 0 5px 20px rgba(218, 165, 32, 0.4);
}

@keyframes gradientBtn {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

.lottery-start-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
  animation: btnShine 2s ease infinite;
}

@keyframes btnShine {
  0% { left: -100%; }
  50%, 100% { left: 100%; }
}

.lottery-start-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 15px 40px rgba(218, 165, 32, 0.5);
}

.lottery-start-btn:active {
  transform: translateY(0);
}

.lottery-start-btn:disabled {
  opacity: 0.7;
  cursor: not-allowed;
  animation: none;
}

.lottery-start-btn:disabled::before {
  display: none;
}


.scratch-container {
  position: relative;
  width: 100%;
  aspect-ratio: 16/10;
  border-radius: 20px;
  overflow: hidden;
  margin-bottom: 20px;
  box-shadow: 0 10px 40px rgba(139, 0, 0, 0.3), 0 0 0 3px #FFD700;
  transform: scale(0);
  animation: cardAppear 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
}

@keyframes cardAppear {
  0% { transform: scale(0) rotateY(180deg); }
  100% { transform: scale(1) rotateY(0deg); }
}

.scratch-result-layer {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px;
  background: linear-gradient(135deg, #FFF8DC 0%, #FFE4B5 100%);
  
  opacity: 1;
  transition: opacity 0.5s ease;
}

.scratch-result-layer.win {
  background: linear-gradient(135deg, #FFD700 0%, #FFA500 50%, #FFD700 100%);
  position: relative;
}

.scratch-result-layer.win::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background:
    radial-gradient(circle at 20% 30%, rgba(255,255,255,0.4) 0%, transparent 30%),
    radial-gradient(circle at 80% 70%, rgba(255,255,255,0.3) 0%, transparent 25%);
  pointer-events: none;
}

.scratch-result-layer.lose {
  background: linear-gradient(135deg, #E8E4D9 0%, #D4CFC4 50%, #C8C3B8 100%);
}


.scratch-result-layer.revealed {
  opacity: 1;
}

.scratch-canvas {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 24 24'%3E%3Ccircle cx='12' cy='12' r='10' fill='%23FFD700' stroke='%23DAA520' stroke-width='2'/%3E%3C/svg%3E") 16 16, crosshair;
  touch-action: none;
  transition: opacity 0.5s ease;
}

.scratch-canvas.hidden {
  opacity: 0;
  pointer-events: none;
}


.result-icon {
  width: 70px;
  height: 70px;
  margin-bottom: 12px;
}


.result-prize-image {
  width: 80px;
  height: 80px;
  object-fit: cover;
  border-radius: 12px;
  margin-bottom: 12px;
  border: 3px solid #DC143C;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.scratch-result-layer.revealed .result-prize-image {
  animation: resultPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.scratch-result-layer.revealed .result-icon {
  animation: resultPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes resultPop {
  0% { transform: scale(0); }
  50% { transform: scale(1.2); }
  100% { transform: scale(1); }
}

.result-title {
  font-size: 26px;
  font-weight: 900;
  margin: 0 0 8px;
  text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.scratch-result-layer.revealed .result-title {
  animation: resultSlide 0.6s ease 0.2s both;
}

@keyframes resultSlide {
  0% { opacity: 0; transform: translateY(20px); }
  100% { opacity: 1; transform: translateY(0); }
}

.result-title.win {
  color: #8B0000;
  text-shadow: 0 2px 10px rgba(139, 0, 0, 0.3);
}

.result-title.lose {
  color: #8B4513;
}

.result-prize-name {
  font-size: 20px;
  font-weight: 700;
  color: #8B0000;
  margin: 0;
}

.scratch-result-layer.revealed .result-prize-name {
  animation: resultSlide 0.6s ease 0.3s both;
}


.scratch-progress {
  margin-bottom: 15px;
}

.scratch-progress-bar {
  height: 10px;
  background: #FFE4E1;
  border-radius: 5px;
  overflow: hidden;
  border: 2px solid #DC143C;
}

.scratch-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #DC143C, #FFD700, #DC143C);
  background-size: 200% 100%;
  border-radius: 3px;
  transition: width 0.1s ease;
  animation: progressShine 1s linear infinite;
}

@keyframes progressShine {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

.scratch-progress-text {
  font-size: 14px;
  color: #8B0000;
  text-align: center;
  margin-top: 8px;
  font-weight: 600;
}


.redemption-box {
  background: linear-gradient(135deg, #DC143C 0%, #B22222 100%);
  border: 3px solid #FFD700;
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
  text-align: center;
  animation: slideUp 0.6s ease 0.4s both;
  position: relative;
  overflow: hidden;
}

.redemption-box::before {
  content: 'ÊÅ≠ÂñúÁôºË≤°';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 60px;
  color: rgba(255, 215, 0, 0.1);
  font-family: 'Ma Shan Zheng', cursive;
  white-space: nowrap;
  pointer-events: none;
}

@keyframes slideUp {
  0% { opacity: 0; transform: translateY(30px); }
  100% { opacity: 1; transform: translateY(0); }
}

.redemption-label {
  font-size: 16px;
  color: #FFD700;
  margin-bottom: 12px;
  font-weight: 600;
  position: relative;
}

.redemption-code-display {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  position: relative;
}

.redemption-code {
  font-family: 'Courier New', monospace;
  font-size: 24px;
  font-weight: 900;
  color: #8B0000;
  background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
  padding: 12px 20px;
  border-radius: 12px;
  letter-spacing: 2px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
  border: 2px solid #DAA520;
}

.copy-btn {
  background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
  border: 2px solid #DAA520;
  border-radius: 10px;
  padding: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.copy-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 5px 15px rgba(218, 165, 32, 0.5);
}

.copy-btn svg {
  width: 24px;
  height: 24px;
  color: #8B0000;
}

.redemption-note {
  font-size: 13px;
  color: #FFE4B5;
  margin-top: 12px;
  position: relative;
}


.result-message {
  font-size: 16px;
  color: #8B0000;
  text-align: center;
  margin-bottom: 20px;
  animation: slideUp 0.6s ease 0.5s both;
  font-weight: 500;
}


.lottery-retry-btn {
  width: 100%;
  padding: 16px 32px;
  font-size: 18px;
  font-weight: 700;
  color: #DC143C;
  background: linear-gradient(135deg, #FFF8DC 0%, #FFE4B5 100%);
  border: 3px solid #DC143C;
  border-radius: 16px;
  cursor: pointer;
  transition: all 0.3s ease;
  animation: slideUp 0.6s ease 0.6s both;
}

.lottery-retry-btn:hover {
  background: linear-gradient(135deg, #DC143C 0%, #B22222 100%);
  color: #FFD700;
  transform: translateY(-3px);
  box-shadow: 0 10px 30px rgba(220, 20, 60, 0.3);
}


.confetti-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 9999;
  overflow: hidden;
}

.confetti {
  position: absolute;
  top: -20px;
  animation: confettiFall 3s ease-in-out forwards;
}

.confetti.red-packet {
  width: 30px;
  height: 40px;
  background: linear-gradient(135deg, #DC143C 0%, #B22222 100%);
  border-radius: 4px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.3);
}

.confetti.red-packet::before {
  content: 'Á¶è';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: #FFD700;
  font-size: 16px;
  font-weight: bold;
}

.confetti.gold-coin {
  width: 25px;
  height: 25px;
  background: radial-gradient(circle at 30% 30%, #FFD700, #DAA520);
  border-radius: 50%;
  box-shadow: inset -2px -2px 6px rgba(0,0,0,0.3);
}

@keyframes confettiFall {
  0% {
    transform: translateY(0) rotateZ(0deg) rotateY(0deg);
    opacity: 1;
  }
  100% {
    transform: translateY(100vh) rotateZ(720deg) rotateY(360deg);
    opacity: 0;
  }
}


.firework {
  position: fixed;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  animation: fireworkExplode 1.2s ease-out forwards;
}

@keyframes fireworkExplode {
  0% {
    transform: scale(1);
    opacity: 1;
  }
  100% {
    transform: scale(0);
    opacity: 0;
  }
}


.firecracker-explosion {
  position: fixed;
  pointer-events: none;
  z-index: 10000;
}

.explosion-particle {
  position: absolute;
  width: 6px;
  height: 6px;
  background: #FFD700;
  border-radius: 50%;
  animation: explode 0.8s ease-out forwards;
}

@keyframes explode {
  0% {
    transform: translate(0, 0) scale(1);
    opacity: 1;
  }
  100% {
    opacity: 0;
  }
}


.loader {
  width: 40px;
  height: 40px;
  border: 4px solid #FFE4E1;
  border-top: 4px solid #DC143C;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}


.loading-text {
  margin-top: 20px;
  color: #8B0000;
  font-weight: 500;
}


.lottery-message-box {
  text-align: center;
  padding: 40px 20px;
}

.lottery-message-icon {
  width: 80px;
  height: 80px;
  margin: 0 auto 20px;
  opacity: 0.8;
}

.lottery-message-title {
  font-size: 24px;
  font-weight: 700;
  color: #8B0000;
  margin: 0 0 10px;
}

.lottery-message-text {
  font-size: 16px;
  color: #8B4513;
  margin: 0 0 25px;
}

.lottery-login-btn {
  display: inline-block;
  padding: 14px 40px;
  font-size: 16px;
  font-weight: 700;
  color: #8B0000;
  background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
  border: 2px solid #DAA520;
  border-radius: 12px;
  text-decoration: none;
  transition: all 0.3s ease;
  box-shadow: 0 5px 15px rgba(218, 165, 32, 0.4);
}

.lottery-login-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 30px rgba(218, 165, 32, 0.5);
  color: #8B0000;
  text-decoration: none;
}


.hidden {
  display: none !important;
}


@media (max-width: 480px) {
  .lottery-wrapper {
    padding: 15px;
    padding-bottom: 100px;
  }

  .lottery-title {
    font-size: 26px;
  }

  .lottery-start-btn {
    font-size: 18px;
    padding: 16px 32px;
  }

  .redemption-code {
    font-size: 18px;
    padding: 10px 15px;
  }

  .firecracker-string {
    transform: scale(0.8);
  }

  .horse-container {
    height: 80px;
  }

  .running-horse svg {
    width: 100px;
    height: 70px;
  }

  .running-horse.horse-2 svg {
    width: 70px;
    height: 50px;
  }
}
</style>

<div class="lottery-bg"></div>
<div class="particles" id="particles"></div>


<div class="firecracker-container" id="firecracker-container">
  <div class="firecracker-string left">
    <div class="firecracker-rope"></div>
    <div class="firecracker"></div>
    <div class="firecracker-rope"></div>
    <div class="firecracker"></div>
    <div class="firecracker-rope"></div>
    <div class="firecracker"></div>
    <div class="firecracker-rope"></div>
    <div class="firecracker"></div>
    <div class="firecracker-rope"></div>
    <div class="firecracker"></div>
    <div class="firecracker-rope"></div>
    <div class="firecracker"></div>
    <div class="firecracker-rope"></div>
    <div class="firecracker"></div>
    <div class="firecracker-rope"></div>
    <div class="firecracker"></div>
  </div>
  <div class="firecracker-string right">
    <div class="firecracker-rope"></div>
    <div class="firecracker"></div>
    <div class="firecracker-rope"></div>
    <div class="firecracker"></div>
    <div class="firecracker-rope"></div>
    <div class="firecracker"></div>
    <div class="firecracker-rope"></div>
    <div class="firecracker"></div>
    <div class="firecracker-rope"></div>
    <div class="firecracker"></div>
    <div class="firecracker-rope"></div>
    <div class="firecracker"></div>
    <div class="firecracker-rope"></div>
    <div class="firecracker"></div>
    <div class="firecracker-rope"></div>
    <div class="firecracker"></div>
  </div>
</div>


<div class="horse-container">
  <div class="running-horse">
    <svg viewBox="0 0 200 140" fill="none" xmlns="http://www.w3.org/2000/svg" width="150" height="105">
      
      <ellipse cx="100" cy="70" rx="55" ry="35" fill="url(#horseBody)"/>
      
      <path d="M145 55 Q165 35 170 45 Q175 55 165 65 Q155 75 145 70 Z" fill="url(#horseBody)"/>
      
      <path d="M160 40 Q165 30 168 38 Q166 45 160 45 Z" fill="url(#horseBody)"/>
      
      <circle cx="162" cy="52" r="3" fill="#1a1a1a"/>
      <circle cx="163" cy="51" r="1" fill="white"/>
      
      <path d="M145 50 Q130 30 120 45 Q135 35 140 50" fill="#8B0000"/>
      <path d="M135 55 Q120 35 110 50 Q125 40 130 55" fill="#8B0000"/>
      <path d="M125 58 Q110 40 100 55 Q115 45 120 60" fill="#8B0000"/>
      
      <path d="M45 65 Q20 50 15 70 Q20 90 45 80" fill="#8B0000" class="horse-tail"/>
      <path d="M45 68 Q25 55 22 72 Q27 85 45 78" fill="#6B0000" class="horse-tail"/>
      
      <path d="M120 95 Q125 115 120 130 Q118 135 115 130 Q110 115 115 95" fill="url(#horseBody)" class="front-leg-1"/>
      <path d="M135 95 Q140 115 135 130 Q133 135 130 130 Q125 115 130 95" fill="url(#horseBody)" class="front-leg-2"/>
      
      <path d="M65 95 Q70 115 65 130 Q63 135 60 130 Q55 115 60 95" fill="url(#horseBody)" class="back-leg-1"/>
      <path d="M80 95 Q85 115 80 130 Q78 135 75 130 Q70 115 75 95" fill="url(#horseBody)" class="back-leg-2"/>
      
      <ellipse cx="117" cy="132" rx="5" ry="3" fill="#4a3728"/>
      <ellipse cx="132" cy="132" rx="5" ry="3" fill="#4a3728"/>
      <ellipse cx="62" cy="132" rx="5" ry="3" fill="#4a3728"/>
      <ellipse cx="77" cy="132" rx="5" ry="3" fill="#4a3728"/>
      
      <path d="M155 60 Q160 65 165 60 Q170 70 165 75 Q155 70 155 60" fill="#DC143C"/>
      <circle cx="163" cy="62" r="4" fill="#FFD700"/>
      
      <defs>
        <linearGradient id="horseBody" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#D4A574"/>
          <stop offset="50%" style="stop-color:#C4956A"/>
          <stop offset="100%" style="stop-color:#A67B5B"/>
        </linearGradient>
      </defs>
      <style>
        .horse-tail { animation: tailWag 0.8s ease-in-out infinite alternate; transform-origin: 45px 72px; }
        .front-leg-1 { animation: legRun1 0.5s ease-in-out infinite; transform-origin: 117px 95px; }
        .front-leg-2 { animation: legRun2 0.5s ease-in-out infinite; transform-origin: 132px 95px; }
        .back-leg-1 { animation: legRun2 0.5s ease-in-out infinite; transform-origin: 62px 95px; }
        .back-leg-2 { animation: legRun1 0.5s ease-in-out infinite; transform-origin: 77px 95px; }
        @keyframes tailWag { 0% { transform: rotate(-10deg); } 100% { transform: rotate(10deg); } }
        @keyframes legRun1 { 0% { transform: rotate(-20deg); } 100% { transform: rotate(20deg); } }
        @keyframes legRun2 { 0% { transform: rotate(20deg); } 100% { transform: rotate(-20deg); } }
      </style>
    </svg>
  </div>
  <div class="running-horse horse-2">
    <svg viewBox="0 0 200 140" fill="none" xmlns="http://www.w3.org/2000/svg" width="100" height="70">
      <ellipse cx="100" cy="70" rx="55" ry="35" fill="url(#horseBody2)"/>
      <path d="M145 55 Q165 35 170 45 Q175 55 165 65 Q155 75 145 70 Z" fill="url(#horseBody2)"/>
      <path d="M160 40 Q165 30 168 38 Q166 45 160 45 Z" fill="url(#horseBody2)"/>
      <circle cx="162" cy="52" r="3" fill="#1a1a1a"/>
      <path d="M145 50 Q130 30 120 45 Q135 35 140 50" fill="#5D4037"/>
      <path d="M135 55 Q120 35 110 50 Q125 40 130 55" fill="#5D4037"/>
      <path d="M45 65 Q20 50 15 70 Q20 90 45 80" fill="#5D4037" class="horse-tail"/>
      <path d="M120 95 Q125 115 120 130 Q118 135 115 130 Q110 115 115 95" fill="url(#horseBody2)" class="front-leg-1"/>
      <path d="M135 95 Q140 115 135 130 Q133 135 130 130 Q125 115 130 95" fill="url(#horseBody2)" class="front-leg-2"/>
      <path d="M65 95 Q70 115 65 130 Q63 135 60 130 Q55 115 60 95" fill="url(#horseBody2)" class="back-leg-1"/>
      <path d="M80 95 Q85 115 80 130 Q78 135 75 130 Q70 115 75 95" fill="url(#horseBody2)" class="back-leg-2"/>
      <ellipse cx="117" cy="132" rx="5" ry="3" fill="#4a3728"/>
      <ellipse cx="132" cy="132" rx="5" ry="3" fill="#4a3728"/>
      <ellipse cx="62" cy="132" rx="5" ry="3" fill="#4a3728"/>
      <ellipse cx="77" cy="132" rx="5" ry="3" fill="#4a3728"/>
      <defs>
        <linearGradient id="horseBody2" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#8B7355"/>
          <stop offset="50%" style="stop-color:#7B6348"/>
          <stop offset="100%" style="stop-color:#6B5344"/>
        </linearGradient>
      </defs>
    </svg>
  </div>
</div>

<div class="lottery-wrapper">
  <div class="lottery-card">
    
    <div id="lottery-loading" class="lottery-content">
      <div style="text-align: center; padding: 60px 20px;">
        <div class="loader"></div>
        <p class="loading-text">ËºâÂÖ•‰∏≠...</p>
      </div>
    </div>

    
    <div id="lottery-login" class="hidden">
      <div class="lottery-header">
        <svg class="lottery-icon" viewBox="0 0 24 24" fill="none" stroke="#FFD700" stroke-width="2">
          <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4M10 17l5-5-5-5M15 12H3"/>
        </svg>
        <h1 class="lottery-title">ÊúÉÂì°Â∞àÂ±¨Ê¥ªÂãï</h1>
        <p class="lottery-subtitle">ÁôªÂÖ•Âç≥ÂèØÂèÉÂä†Êñ∞Êò•ÂàÆÂàÆÊ®Ç</p>
        <div class="cny-blessing">
          <span class="blessing-char">È¶¨</span>
          <span class="blessing-char">Âà∞</span>
          <span class="blessing-char">Êàê</span>
          <span class="blessing-char">Âäü</span>
        </div>
      </div>
      <div class="lottery-message-box">
        <p class="lottery-message-text">Ë´ãÂÖàÁôªÂÖ•ÊúÉÂì°Â∏≥ËôüÊâçËÉΩÂèÉÂä†ÂàÆÂàÆÊ®ÇÊ¥ªÂãï</p>
        <a href="/users/sign_in" class="lottery-login-btn">üßß Á´ãÂç≥ÁôªÂÖ•</a>
      </div>
    </div>

    
    <div id="lottery-error" class="hidden">
      <div class="lottery-header" style="background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);">
        <svg class="lottery-icon" viewBox="0 0 24 24" fill="none" stroke="#FFD700" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <line x1="12" y1="8" x2="12" y2="12"/>
          <line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        <h1 class="lottery-title">ÁÑ°Ê≥ïÂèÉÂä†</h1>
      </div>
      <div class="lottery-message-box">
        <p id="lottery-error-msg" class="lottery-message-text"></p>
      </div>
    </div>

    
    <div id="lottery-already-played" class="hidden">
      <div id="already-played-header" class="lottery-header">
        <svg id="already-played-icon-win" class="lottery-icon hidden" viewBox="0 0 24 24" fill="none" stroke="#FFD700" stroke-width="2">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
          <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
        <svg id="already-played-icon-lose" class="lottery-icon hidden" viewBox="0 0 24 24" fill="none" stroke="#FFD700" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <line x1="15" y1="9" x2="9" y2="15"/>
          <line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
        <h1 id="already-played-title" class="lottery-title"></h1>
        <p class="lottery-subtitle">ÊÇ®Â∑≤ÂèÉÂä†ÈÅéÊ≠§Ê¥ªÂãï</p>
        <div class="cny-blessing">
          <span class="blessing-char">È¶¨</span>
          <span class="blessing-char">Âπ¥</span>
          <span class="blessing-char">Âêâ</span>
          <span class="blessing-char">Á••</span>
        </div>
      </div>
      <div class="lottery-content">
        
        <div id="already-played-notice-section" class="lottery-notice-section hidden">
          <p id="already-played-notice" class="lottery-notice-text"></p>
        </div>

        
        <div id="already-played-prize-box" class="hidden" style="text-align: center; margin-bottom: 20px;">
          <img id="already-played-prize-image" style="width: 120px; height: 120px; object-fit: cover; border-radius: 16px; border: 3px solid #FFD700; box-shadow: 0 5px 20px rgba(0,0,0,0.2);" src="" alt="ÁçéÂìÅ" />
        </div>

        
        <div id="already-played-redemption" class="redemption-box hidden">
          <p class="redemption-label">üßß ÊÇ®ÁöÑÂ∞àÂ±¨ÂÖåÊèõÁ¢º üßß</p>
          <div class="redemption-code-display">
            <span id="already-played-code" class="redemption-code"></span>
            <button class="copy-btn" onclick="copyAlreadyPlayedCode()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2"/>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
              </svg>
            </button>
          </div>
          <p id="already-played-redeem-status" class="redemption-note"></p>
        </div>

        <p id="already-played-message" class="result-message"></p>
        <p id="already-played-time" style="text-align: center; color: #8B4513; font-size: 14px; margin-top: 10px;"></p>
      </div>
    </div>

    
    <div id="lottery-ready" class="hidden">
      <div class="lottery-header">
        <svg class="lottery-icon" viewBox="0 0 24 24" fill="none" stroke="#FFD700" stroke-width="2">
          <path d="M20 12v10H4V12M22 7H2v5h20V7zM12 22V7M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7zM12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/>
        </svg>
        <h1 id="campaign-name" class="lottery-title"></h1>
        <p id="campaign-desc" class="lottery-subtitle"></p>
        <div class="cny-blessing">
          <span class="blessing-char">È¶¨</span>
          <span class="blessing-char">Âπ¥</span>
          <span class="blessing-char">Ë°å</span>
          <span class="blessing-char">ÈÅã</span>
        </div>
      </div>
      <div class="lottery-content">
        
        <div id="frontend-notice-section" class="lottery-notice-section hidden">
          <p id="frontend-notice" class="lottery-notice-text"></p>
        </div>
        
        <div id="prizes-section" class="lottery-prizes-section hidden">
          <p class="lottery-prizes-title">üéä Ë±êÂØåÁçéÂìÅÁ≠â‰Ω†‰æÜÊãø üéä</p>
          <div id="prizes-list" class="lottery-prizes-grid"></div>
        </div>
        <button id="start-btn" class="lottery-start-btn" onclick="startScratchGame()">
          üßß ÈñãÂßãÂàÆÁçé üßß
        </button>
      </div>
    </div>

    
    <div id="lottery-scratch" class="hidden">
      <div class="lottery-header">
        <h1 id="scratch-title" class="lottery-title"></h1>
        <p class="lottery-subtitle">Áî®ÊâãÊåáÂàÆÈñãÈáëËâ≤ÂçÄÂüüË©¶Ë©¶ÊâãÊ∞£</p>
      </div>
      <div class="lottery-content">
        <div class="scratch-container" id="scratch-container">
          <div id="scratch-result" class="scratch-result-layer">
            
            <img id="prize-image" class="result-prize-image hidden" src="" alt="ÁçéÂìÅÂúñÁâá" />
            <svg id="win-icon" class="result-icon hidden" viewBox="0 0 24 24" fill="none" stroke="#DC143C" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
              <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
            <svg id="lose-icon" class="result-icon hidden" viewBox="0 0 24 24" fill="none" stroke="#8B4513" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="15" y1="9" x2="9" y2="15"/>
              <line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
            <h2 id="result-title" class="result-title"></h2>
            <p id="prize-name" class="result-prize-name"></p>
          </div>
          <canvas id="scratch-canvas" class="scratch-canvas"></canvas>
        </div>

        <div id="progress-box" class="scratch-progress">
          <div class="scratch-progress-bar">
            <div id="progress-fill" class="scratch-progress-fill" style="width: 0%;"></div>
          </div>
          <p id="progress-text" class="scratch-progress-text">ÈñãÂßãÂàÆÂêßÔºÅÁ•ùÊÇ®È¶¨Âà∞ÊàêÂäüÔºÅ</p>
        </div>

        <div id="redemption-box" class="redemption-box hidden">
          <p class="redemption-label">üßß ÊÅ≠ÂñúÁôºË≤°ÔºÅÊÇ®ÁöÑÂ∞àÂ±¨ÂÖåÊèõÁ¢º üßß</p>
          <div class="redemption-code-display">
            <span id="redemption-code" class="redemption-code"></span>
            <button class="copy-btn" onclick="copyRedemptionCode()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2"/>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
              </svg>
            </button>
          </div>
          <p class="redemption-note">üì± Ë´ãÊà™Âúñ‰øùÂ≠òÔºåÂÖåÁçéÊôÇÂá∫Á§∫Ê≠§Áï´Èù¢</p>
        </div>

        <p id="result-msg" class="result-message hidden"></p>

        <button id="retry-btn" class="lottery-retry-btn hidden" onclick="retryGame()">
          üîÑ ÂÜçÂàÆ‰∏ÄÊ¨°
        </button>
      </div>
    </div>
  </div>
</div>

<div id="confetti-container" class="confetti-container"></div>

<script>
(function() {
  
  
  
  const API_BASE_URL = 'https://carbs-reduced-admin.com';
  const CAMPAIGN_ID = '5973d399-3f88-4dd6-bd6b-6ca8d53f07aa';

  
  
  
  let customerId = null;
  let customerEmail = null;
  let customerName = null;
  let eligibility = null;
  let scratchResult = null;
  let isRevealed = false;
  let isDrawing = false;
  let canvas = null;
  let ctx = null;

  
  
  
  document.addEventListener('DOMContentLoaded', function() {
    
    createParticles();

    
    setInterval(createFirecrackerSparks, 2000);

    
    {% if customer %}
    customerId = "{{ customer.id }}";
    customerEmail = "{{ customer.email }}";
    customerName = "{{ customer.name }}";
    {% endif %}

    
    checkEligibility();
  });

  
  function createParticles() {
    const container = document.getElementById('particles');
    for (let i = 0; i < 15; i++) {
      const particle = document.createElement('div');
      const isCoin = Math.random() > 0.4;
      particle.className = 'particle ' + (isCoin ? 'coin' : 'lantern');
      particle.style.left = Math.random() * 100 + '%';
      particle.style.animationDelay = Math.random() * 20 + 's';
      particle.style.animationDuration = (30 + Math.random() * 15) + 's';
      if (isCoin) {
        particle.innerHTML = 'Á¶è';
      }
      container.appendChild(particle);
    }
  }

  
  function createFirecrackerSparks() {
    const container = document.getElementById('firecracker-container');
    const firecrackers = container.querySelectorAll('.firecracker');

    firecrackers.forEach((fc, index) => {
      if (Math.random() > 0.7) {
        const spark = document.createElement('div');
        spark.className = 'firecracker-spark';
        spark.style.left = (Math.random() * 10 - 5) + 'px';
        spark.style.top = '-8px';
        fc.appendChild(spark);
        setTimeout(() => spark.remove(), 500);
      }
    });
  }

  
  
  
  function checkEligibility() {
    showState('loading');

    let url = API_BASE_URL + '/api/lottery/campaigns/' + CAMPAIGN_ID + '/check';
    if (customerId) {
      url += '?customer_id=' + encodeURIComponent(customerId);
    }

    fetch(url)
      .then(res => res.json())
      .then(data => {
        eligibility = data;

        if (data.eligible) {
          showReady();
        } else if (data.campaign && data.campaign.require_login && !customerId) {
          showState('login');
        } else if (data.last_result) {
          
          showAlreadyPlayed(data.last_result, data.campaign);
        } else {
          showError(data.reason || 'ÁÑ°Ê≥ïÂèÉÂä†Ê≠§Ê¥ªÂãï');
        }
      })
      .catch(err => {
        console.error('Check eligibility error:', err);
        showError('ÁÑ°Ê≥ïÈÄ£Á∑öÂà∞‰º∫ÊúçÂô®ÔºåË´ãÁ®çÂæåÂÜçË©¶');
      });
  }

  
  
  
  function showState(state) {
    document.getElementById('lottery-loading').classList.add('hidden');
    document.getElementById('lottery-login').classList.add('hidden');
    document.getElementById('lottery-error').classList.add('hidden');
    document.getElementById('lottery-ready').classList.add('hidden');
    document.getElementById('lottery-scratch').classList.add('hidden');
    document.getElementById('lottery-already-played').classList.add('hidden');

    document.getElementById('lottery-' + state).classList.remove('hidden');
  }

  function showError(message) {
    document.getElementById('lottery-error-msg').textContent = message;
    showState('error');
  }

  function showAlreadyPlayed(lastResult, campaign) {
    const header = document.getElementById('already-played-header');
    const winIcon = document.getElementById('already-played-icon-win');
    const loseIcon = document.getElementById('already-played-icon-lose');
    const title = document.getElementById('already-played-title');
    const noticeSection = document.getElementById('already-played-notice-section');
    const noticeText = document.getElementById('already-played-notice');
    const prizeBox = document.getElementById('already-played-prize-box');
    const prizeImage = document.getElementById('already-played-prize-image');
    const redemptionBox = document.getElementById('already-played-redemption');
    const codeDisplay = document.getElementById('already-played-code');
    const redeemStatus = document.getElementById('already-played-redeem-status');
    const message = document.getElementById('already-played-message');
    const timeDisplay = document.getElementById('already-played-time');

    
    winIcon.classList.add('hidden');
    loseIcon.classList.add('hidden');
    noticeSection.classList.add('hidden');
    prizeBox.classList.add('hidden');
    redemptionBox.classList.add('hidden');

    
    if (campaign && campaign.frontend_notice && campaign.frontend_notice.trim()) {
      noticeText.textContent = campaign.frontend_notice;
      noticeSection.classList.remove('hidden');
    }

    if (lastResult.is_winner) {
      
      header.style.background = 'linear-gradient(135deg, #DC143C 0%, #B22222 50%, #8B0000 100%)';
      winIcon.classList.remove('hidden');
      title.textContent = 'üéâ ÊÅ≠Âñú‰∏≠ÁçéÔºÅ';

      
      if (lastResult.prize && lastResult.prize.image_url) {
        prizeImage.src = lastResult.prize.image_url;
        prizeBox.classList.remove('hidden');
      }

      
      if (lastResult.redemption_code) {
        codeDisplay.textContent = lastResult.redemption_code;
        if (lastResult.is_redeemed) {
          redeemStatus.textContent = '‚úÖ Ê≠§ÁçéÂìÅÂ∑≤ÂÖåÊèõ';
          redeemStatus.style.color = '#90EE90';
        } else {
          redeemStatus.textContent = 'üì± Ë´ãÊà™Âúñ‰øùÂ≠òÔºåÂÖåÁçéÊôÇÂá∫Á§∫Ê≠§Áï´Èù¢';
          redeemStatus.style.color = '#FFE4B5';
        }
        redemptionBox.classList.remove('hidden');
      }

      message.textContent = lastResult.message || 'ÊÅ≠ÂñúÊÇ®Áç≤ÂæóÁçéÂìÅÔºÅ';
      message.style.color = '#8B0000';
    } else {
      
      header.style.background = 'linear-gradient(135deg, #8B4513 0%, #A0522D 100%)';
      loseIcon.classList.remove('hidden');
      title.textContent = 'ÂÜçÊé•ÂÜçÂé≤';
      message.textContent = lastResult.message || 'ÂæàÂèØÊÉúÔºåÈÄôÊ¨°Ê≤íÊúâ‰∏≠Áçé';
      message.style.color = '#8B4513';
    }

    
    if (lastResult.scratched_at) {
      const date = new Date(lastResult.scratched_at);
      timeDisplay.textContent = 'ÂèÉÂä†ÊôÇÈñìÔºö' + date.toLocaleString('zh-TW');
    }

    message.classList.remove('hidden');
    showState('already-played');
  }

  
  let lastResultCode = null;

  window.copyAlreadyPlayedCode = function() {
    const code = document.getElementById('already-played-code').textContent;
    if (code) {
      navigator.clipboard.writeText(code).then(() => {
        const btns = document.querySelectorAll('#already-played-redemption .copy-btn');
        btns.forEach(btn => {
          btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>';
          setTimeout(() => {
            btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';
          }, 2000);
        });
      }).catch(() => {
        alert('ÂÖåÊèõÁ¢º: ' + code);
      });
    }
  };

  function showReady() {
    const campaign = eligibility.campaign;

    document.getElementById('campaign-name').textContent = campaign.name || 'Êñ∞Êò•ÂàÆÂàÆÊ®Ç';
    document.getElementById('campaign-desc').textContent = campaign.description || 'È¶¨Âπ¥Ë°åÂ§ßÈÅãÔºÅË©¶Ë©¶ÊâãÊ∞£ÂêßÔºÅ';

    
    const noticeSection = document.getElementById('frontend-notice-section');
    const noticeText = document.getElementById('frontend-notice');
    if (campaign.frontend_notice && campaign.frontend_notice.trim()) {
      noticeText.textContent = campaign.frontend_notice;
      noticeSection.classList.remove('hidden');
    } else {
      noticeSection.classList.add('hidden');
    }

    
    const prizesSection = document.getElementById('prizes-section');
    const prizesList = document.getElementById('prizes-list');
    prizesList.innerHTML = '';

    if (campaign.prizes && campaign.prizes.length > 0) {
      
      prizesSection.classList.remove('hidden');

      campaign.prizes.forEach(prize => {
        const card = document.createElement('div');
        card.className = 'lottery-prize-card';

        
        if (prize.image_url) {
          const img = document.createElement('img');
          img.src = prize.image_url;
          img.alt = prize.name;
          img.onerror = function() {
            
            this.parentNode.innerHTML = '<div class="prize-placeholder">üéÅ</div><span>' + prize.name + '</span>';
          };
          card.appendChild(img);
        } else {
          const placeholder = document.createElement('div');
          placeholder.className = 'prize-placeholder';
          placeholder.textContent = 'üéÅ';
          card.appendChild(placeholder);
        }

        const nameSpan = document.createElement('span');
        nameSpan.textContent = prize.name;
        card.appendChild(nameSpan);

        prizesList.appendChild(card);
      });
    } else {
      
      prizesSection.classList.add('hidden');
    }

    showState('ready');
  }

  
  
  
  window.startScratchGame = function() {
    const btn = document.getElementById('start-btn');
    btn.disabled = true;
    btn.innerHTML = '<div class="loader" style="display:inline-block;width:24px;height:24px;margin-right:10px;vertical-align:middle;border-width:3px;"></div> Ê∫ñÂÇô‰∏≠...';

    fetch(API_BASE_URL + '/api/lottery/campaigns/' + CAMPAIGN_ID + '/scratch', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        customer_id: customerId,
        customer_email: customerEmail,
        customer_name: customerName
      })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        scratchResult = data.result;
        showScratchCard();
      } else {
        showError(data.error || 'ÂàÆÁçéÂ§±Êïó');
      }
    })
    .catch(err => {
      console.error('Scratch error:', err);
      showError('Á∂≤Ë∑ØÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶');
    });
  };

  
  
  
  function showScratchCard() {
    document.getElementById('scratch-title').textContent = eligibility.campaign.name || 'Êñ∞Êò•ÂàÆÂàÆÊ®Ç';

    
    const resultLayer = document.getElementById('scratch-result');
    const winIcon = document.getElementById('win-icon');
    const loseIcon = document.getElementById('lose-icon');
    const prizeImage = document.getElementById('prize-image');
    const resultTitle = document.getElementById('result-title');
    const prizeName = document.getElementById('prize-name');

    resultLayer.classList.remove('win', 'lose', 'revealed');
    winIcon.classList.add('hidden');
    loseIcon.classList.add('hidden');
    prizeImage.classList.add('hidden');

    if (scratchResult.is_winner) {
      resultLayer.classList.add('win');

      
      if (scratchResult.prize && scratchResult.prize.image_url) {
        prizeImage.src = scratchResult.prize.image_url;
        prizeImage.classList.remove('hidden');
      } else {
        winIcon.classList.remove('hidden');
      }

      resultTitle.textContent = 'ÊÅ≠Âñú‰∏≠Áçé';
      resultTitle.className = 'result-title win';
      prizeName.textContent = scratchResult.prize.name;
    } else {
      resultLayer.classList.add('lose');
      loseIcon.classList.remove('hidden');
      resultTitle.textContent = 'ÂÜçÊé•ÂÜçÂé≤';
      resultTitle.className = 'result-title lose';
      prizeName.textContent = '‰∏ãÊ¨°‰∏ÄÂÆö‰∏≠';
    }

    
    isRevealed = false;
    document.getElementById('progress-box').classList.remove('hidden');
    document.getElementById('redemption-box').classList.add('hidden');
    document.getElementById('result-msg').classList.add('hidden');
    document.getElementById('retry-btn').classList.add('hidden');
    document.getElementById('progress-fill').style.width = '0%';
    document.getElementById('progress-text').textContent = 'ÈñãÂßãÂàÆÂêßÔºÅÁ•ùÊÇ®È¶¨Âà∞ÊàêÂäüÔºÅ';

    showState('scratch');

    
    setTimeout(initCanvas, 100);
  }

  function initCanvas() {
    canvas = document.getElementById('scratch-canvas');
    ctx = canvas.getContext('2d');
    canvas.classList.remove('hidden');

    const container = document.getElementById('scratch-container');
    const rect = container.getBoundingClientRect();
    canvas.width = rect.width;
    canvas.height = rect.height;

    const w = rect.width;
    const h = rect.height;

    const redGradient = ctx.createLinearGradient(0, 0, w, h);
    redGradient.addColorStop(0, '#C41E3A');
    redGradient.addColorStop(0.5, '#DC143C');
    redGradient.addColorStop(1, '#B22222');
    ctx.fillStyle = redGradient;
    ctx.fillRect(0, 0, w, h);

    ctx.strokeStyle = '#FFD700';
    ctx.lineWidth = 5;
    ctx.strokeRect(5, 5, w - 10, h - 10);
    ctx.strokeStyle = '#DAA520';
    ctx.lineWidth = 2;
    ctx.strokeRect(12, 12, w - 24, h - 24);

    ctx.strokeStyle = '#FFD700';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(18, 32); ctx.lineTo(18, 18); ctx.lineTo(32, 18);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(w - 32, 18); ctx.lineTo(w - 18, 18); ctx.lineTo(w - 18, 32);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(18, h - 32); ctx.lineTo(18, h - 18); ctx.lineTo(32, h - 18);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(w - 32, h - 18); ctx.lineTo(w - 18, h - 18); ctx.lineTo(w - 18, h - 32);
    ctx.stroke();

    const centerX = w / 2;
    const centerY = h / 2;

    ctx.save();
    ctx.translate(w * 0.2, centerY + 8);
    ctx.scale(0.45, 0.45);
    drawHorseSilhouette(ctx, '#FFD700');
    ctx.restore();

    ctx.save();
    ctx.translate(w * 0.8, centerY + 8);
    ctx.scale(-0.45, 0.45);
    drawHorseSilhouette(ctx, '#FFD700');
    ctx.restore();

    ctx.fillStyle = '#FFD700';
    ctx.font = 'bold 26px "Noto Sans TC", sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.shadowColor = 'rgba(0,0,0,0.4)';
    ctx.shadowBlur = 4;
    ctx.shadowOffsetX = 2;
    ctx.shadowOffsetY = 2;
    ctx.fillText('ÂàÆÊàë', centerX, centerY - 6);

    ctx.font = '13px "Noto Sans TC", sans-serif';
    ctx.shadowBlur = 2;
    ctx.fillText('È¶¨Âπ¥Ë°åÂ§ßÈÅã', centerX, centerY + 16);

    ctx.shadowColor = 'transparent';
    ctx.shadowBlur = 0;
    ctx.shadowOffsetX = 0;
    ctx.shadowOffsetY = 0;

    drawCoin(ctx, 40, 40, 10);
    drawCoin(ctx, w - 40, 40, 10);
    drawCoin(ctx, 40, h - 40, 10);
    drawCoin(ctx, w - 40, h - 40, 10);

    canvas.addEventListener('mousedown', handleStart);
    canvas.addEventListener('mousemove', handleMove);
    canvas.addEventListener('mouseup', handleEnd);
    
    canvas.addEventListener('mouseenter', handleEnter);
    canvas.addEventListener('touchstart', handleStart, { passive: false });
    canvas.addEventListener('touchmove', handleMove, { passive: false });
    canvas.addEventListener('touchend', handleEnd);
  }

  function drawHorseSilhouette(ctx, color) {
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.quadraticCurveTo(20, -30, 40, -22);
    ctx.quadraticCurveTo(48, -28, 52, -40);
    ctx.quadraticCurveTo(54, -28, 58, -22);
    ctx.quadraticCurveTo(65, -18, 62, -5);
    ctx.quadraticCurveTo(52, 5, 42, 10);
    ctx.quadraticCurveTo(25, 14, 8, 18);
    ctx.quadraticCurveTo(-15, 22, -35, 14);
    ctx.quadraticCurveTo(-52, 5, -58, -8);
    ctx.quadraticCurveTo(-48, 0, -38, 10);
    ctx.quadraticCurveTo(-35, 30, -32, 48);
    ctx.quadraticCurveTo(-28, 48, -24, 30);
    ctx.quadraticCurveTo(-18, 22, -12, 30);
    ctx.quadraticCurveTo(-8, 48, -4, 48);
    ctx.quadraticCurveTo(0, 30, 4, 22);
    ctx.quadraticCurveTo(22, 26, 26, 48);
    ctx.quadraticCurveTo(30, 48, 34, 30);
    ctx.quadraticCurveTo(38, 22, 42, 30);
    ctx.quadraticCurveTo(46, 48, 50, 48);
    ctx.quadraticCurveTo(54, 30, 52, 14);
    ctx.quadraticCurveTo(35, 5, 0, 0);
    ctx.closePath();
    ctx.fill();

    ctx.beginPath();
    ctx.moveTo(42, 5);
    ctx.quadraticCurveTo(30, -5, 38, -12);
    ctx.quadraticCurveTo(25, -8, 33, -18);
    ctx.quadraticCurveTo(22, -12, 30, -22);
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.stroke();
  }

  function drawCoin(ctx, x, y, r) {
    ctx.beginPath();
    ctx.arc(x, y, r, 0, Math.PI * 2);
    ctx.fillStyle = '#FFD700';
    ctx.fill();
    ctx.strokeStyle = '#B8860B';
    ctx.lineWidth = 1.5;
    ctx.stroke();
    ctx.beginPath();
    ctx.arc(x, y, r * 0.55, 0, Math.PI * 2);
    ctx.strokeStyle = '#8B6914';
    ctx.lineWidth = 1;
    ctx.stroke();
    ctx.fillStyle = '#C41E3A';
    const sq = r * 0.35;
    ctx.fillRect(x - sq, y - sq, sq * 2, sq * 2);
  }

  function handleStart(e) {
    if (isRevealed) return;
    e.preventDefault();
    isDrawing = true;
    scratch(e);
  }

  function handleMove(e) {
    if (!isDrawing || isRevealed) return;
    e.preventDefault();
    scratch(e);
  }

  function handleEnd() {
    isDrawing = false;
  }

  function handleEnter(e) {
    
    if (e.buttons === 1 && !isRevealed) {
      isDrawing = true;
      scratch(e);
    }
  }

  function scratch(e) {
    const rect = canvas.getBoundingClientRect();
    let x, y;

    if (e.touches) {
      x = e.touches[0].clientX - rect.left;
      y = e.touches[0].clientY - rect.top;
    } else {
      x = e.clientX - rect.left;
      y = e.clientY - rect.top;
    }

    
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;

    
    ctx.globalCompositeOperation = 'destination-out';
    ctx.beginPath();
    ctx.arc(x * scaleX, y * scaleY, 8, 0, Math.PI * 2);
    ctx.fill();

    
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    let transparent = 0;
    const step = 8; 
    for (let i = 3; i < imageData.data.length; i += 4 * step) {
      if (imageData.data[i] === 0) transparent++;
    }
    const totalSampled = Math.ceil(imageData.data.length / 4 / step);
    const progress = transparent / totalSampled;

    
    const displayProgress = Math.min(progress * 1.25, 1);
    document.getElementById('progress-fill').style.width = (displayProgress * 100) + '%';

    if (progress < 0.3) {
      document.getElementById('progress-text').textContent = 'ÁπºÁ∫åÂàÆÔºÅÈ¶¨Âà∞ÊàêÂäüÔºÅ';
    } else if (progress < 0.5) {
      document.getElementById('progress-text').textContent = 'Âä†Ê≤πÔºÅÂø´ÁúãÂà∞‰∫Ü...';
    } else if (progress < 0.7) {
      document.getElementById('progress-text').textContent = 'Â•ΩÈÅãÂç≥Â∞áÊè≠ÊõâÔºÅ';
    } else {
      document.getElementById('progress-text').textContent = 'Âç≥Â∞áÊè≠Êõâ...';
    }

    
    if (progress > 0.85 && !isRevealed) {
      revealResult();
    }
  }

  
  
  
  function revealResult() {
    isRevealed = true;

    canvas.classList.add('hidden');
    document.getElementById('progress-box').classList.add('hidden');
    document.getElementById('scratch-result').classList.add('revealed');

    
    if (scratchResult.is_winner) {
      triggerCelebration();

      if (scratchResult.redemption_code) {
        document.getElementById('redemption-code').textContent = scratchResult.redemption_code;
        document.getElementById('redemption-box').classList.remove('hidden');
      }
    }

    
    document.getElementById('result-msg').textContent = scratchResult.message;
    document.getElementById('result-msg').classList.remove('hidden');

    
    if (scratchResult.attempts_remaining > 0) {
      const retryBtn = document.getElementById('retry-btn');
      retryBtn.textContent = 'üîÑ ÂÜçÂàÆ‰∏ÄÊ¨°ÔºàÂâ©È§ò ' + scratchResult.attempts_remaining + ' Ê¨°Ôºâ';
      retryBtn.classList.remove('hidden');
    }
  }

  
  
  
  function triggerCelebration() {
    
    createRedPacketRain();

    
    setTimeout(() => createFirecrackerExplosion(100, 200), 200);
    setTimeout(() => createFirecrackerExplosion(window.innerWidth - 100, 200), 400);
    setTimeout(() => createFirecrackerExplosion(window.innerWidth / 2, 150), 600);

    
    setTimeout(() => createFireworks(), 300);
    setTimeout(() => createFireworks(), 600);
    setTimeout(() => createFireworks(), 900);
  }

  function createRedPacketRain() {
    const container = document.getElementById('confetti-container');

    for (let i = 0; i < 60; i++) {
      setTimeout(() => {
        const item = document.createElement('div');
        const isPacket = Math.random() > 0.5;
        item.className = 'confetti ' + (isPacket ? 'red-packet' : 'gold-coin');
        item.style.left = Math.random() * 100 + '%';
        item.style.animationDuration = (2.5 + Math.random() * 2) + 's';
        item.style.animationDelay = Math.random() * 0.5 + 's';

        container.appendChild(item);

        setTimeout(() => item.remove(), 5000);
      }, i * 30);
    }
  }

  function createFirecrackerExplosion(x, y) {
    const container = document.getElementById('confetti-container');
    const colors = ['#DC143C', '#FFD700', '#FF4500', '#FF6347', '#FFA500'];

    for (let i = 0; i < 20; i++) {
      const particle = document.createElement('div');
      particle.className = 'explosion-particle';
      particle.style.left = x + 'px';
      particle.style.top = y + 'px';
      particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];

      const angle = (Math.PI * 2 / 20) * i;
      const velocity = 40 + Math.random() * 60;
      const dx = Math.cos(angle) * velocity;
      const dy = Math.sin(angle) * velocity;

      particle.style.boxShadow = '0 0 6px 2px ' + particle.style.backgroundColor;
      particle.animate([
        { transform: 'translate(0, 0) scale(1)', opacity: 1 },
        { transform: 'translate(' + dx + 'px, ' + dy + 'px) scale(0)', opacity: 0 }
      ], {
        duration: 800,
        easing: 'cubic-bezier(0, 0.5, 0.5, 1)'
      });

      container.appendChild(particle);
      setTimeout(() => particle.remove(), 800);
    }
  }

  function createFireworks() {
    const container = document.getElementById('confetti-container');
    const colors = ['#DC143C', '#FFD700', '#FF4500', '#FF6347', '#FFA500', '#FFFF00'];
    const x = Math.random() * window.innerWidth;
    const y = Math.random() * (window.innerHeight * 0.4) + 50;

    for (let i = 0; i < 40; i++) {
      const particle = document.createElement('div');
      particle.className = 'firework';
      particle.style.left = x + 'px';
      particle.style.top = y + 'px';
      particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];

      const angle = (Math.PI * 2 / 40) * i;
      const velocity = 60 + Math.random() * 80;
      const dx = Math.cos(angle) * velocity;
      const dy = Math.sin(angle) * velocity;

      particle.style.boxShadow = '0 0 8px 3px ' + particle.style.backgroundColor;
      particle.animate([
        { transform: 'translate(0, 0) scale(1)', opacity: 1 },
        { transform: 'translate(' + dx + 'px, ' + dy + 'px) scale(0)', opacity: 0 }
      ], {
        duration: 1200,
        easing: 'cubic-bezier(0, 0.5, 0.5, 1)'
      });

      container.appendChild(particle);
      setTimeout(() => particle.remove(), 1200);
    }
  }

  
  
  
  window.copyRedemptionCode = function() {
    const code = scratchResult.redemption_code;
    if (code) {
      navigator.clipboard.writeText(code).then(() => {
        const btn = document.querySelector('.copy-btn');
        btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>';
        setTimeout(() => {
          btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';
        }, 2000);
      }).catch(() => {
        alert('ÂÖåÊèõÁ¢º: ' + code);
      });
    }
  };

  
  
  
  window.retryGame = function() {
    scratchResult = null;
    isRevealed = false;
    checkEligibility();
  };
})();
</script>
